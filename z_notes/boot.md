# 实模式
## 1.16位代码

    16位寻址范围64KB
    实模式下寻址范围有1MB
    因此以 (段<<4 + offset)方式寻址，此时有20位，寻址范围1MB


## 2.实模式内存布局

| 起始地址  | 结束地址  | 大小     | 用途               |
| --------- | --------- | -------- | ------------------ |
| `0x000`   | `0x3FF`   | 1KB      | 中断向量表         |
| `0x400`   | `0x4FF`   | 256B     | BIOS 数据区        |
| `0x500`   | `0x7BFF`  | 29.75 KB | 可用区域           |
| `0x7C00`  | `0x7DFF`  | 512B     | MBR 加载区域       |
| `0x7E00`  | `0x9FBFF` | 607.6KB  | 可用区域           |
| `0x9FC00` | `0x9FFFF` | 1KB      | 扩展 BIOS 数据区   |
| `0xA0000` | `0xAFFFF` | 64KB     | 用于彩色显示适配器 |
| `0xB0000` | `0xB7FFF` | 32KB     | 用于黑白显示适配器 |
| `0xB8000` | `0xBFFFF` | 32KB     | 用于文本显示适配器 |
| `0xC0000` | `0xC7FFF` | 32KB     | 显示适配器 BIOS    |
| `0xC8000` | `0xEFFFF` | 160KB    | 映射内存           |
| `0xF0000` | `0xFFFEF` | 64KB-16B | 系统 BIOS          |
| `0xFFFF0` | `0xFFFFF` | 16B      | 系统 BIOS 入口地址 |

## 3. BIOS中断
    只能在实模式使用
    https://wiki.osdev.org/BIOS

## 4.硬盘
    主通道
        主设备 从设备
    次通道
        主设备 从设备

    类型    接口
    机械    IDE
    固态    sata
    闪存    M.2

    1.读取方式
        BIOS中断
        访问控制器端口(CHS LBA28 LBA48)

        1）BIOS中断
            BIOS中断 INT 13h 参数
                AH = 02h：读取扇区功能。
                AL：要读取的扇区数。
                CH：柱面号（低8位）。
                CL：扇区号（低6位）和柱面号的高2位。
                DH：磁头号。
                DL：驱动器号（0x00 表示软盘，0x80 表示硬盘）。
                ES:BX：指向内存缓冲区的指针。

            DL：驱动器号
                主通道
                主设备（Master）：通常设置为 0x80，表示第一个硬盘驱动器。
                从设备（Slave）：通常设置为 0x81，表示第二个硬盘驱动器。
                
                次通道
                主设备（Master）：通常设置为 0x82，表示第三个硬盘驱动器。
                从设备（Slave）：通常设置为 0x83，表示第四个硬盘驱动器
            
        2）LBA方式
            LBA-CHS转换公式：  
            - CYL = LBA / (HPC * SPT)
            - HEAD = (LBA % (HPC * SPT)) / SPT
            - SECT = (LBA % (HPC * SPT)) % SPT + 1
                HPC（Heads Per Cylinder）：每个柱面上的磁头数量。
                SPT（Sectors Per Track）：每个磁道（track）上的扇区数量。

            LBA28:
                LBA28，总共能访问 128G 的磁盘空间；

                硬盘控制端口

                | Primary 通道            | Secondary 通道 | in 操作      | out 操作     |
                | ----------------------- | -------------- | ------------ | ------------ |
                | 0x1F0                   | 0x170          | Data         | Data         |
                | 0x1F1                   | 0x171          | Error        | Features     |
                | 0x1F2                   | 0x172          | Sector count | Sector count |
                | 0x1F3                   | 0x173          | LBA low      | LBA low      |
                | 0x1F4                   | 0x174          | LBA mid      | LBA mid      |
                | 0x1F5                   | 0x175          | LBA high     | LBA high     |
                | 0x1F6                   | 0x176          | Device       | Device       |
                | 0x1F7                   | 0x177          | Status       | Command      |

                - 0x1F0：16bit 端口，用于读写数据
                - 0x1F1：检测前一个指令的错误
                - 0x1F2：读写扇区的数量
                - 0x1F3：起始扇区的 0 ~ 7 位
                - 0x1F4：起始扇区的 8 ~ 15 位
                - 0x1F5：起始扇区的 16 ~ 23 位
                - 0x1F6:
                    - 0 ~ 3：起始扇区的 24 ~ 27 位
                    - 4: 0 主盘, 1 从片
                    - 6: 0 CHS, 1 LBA
                    - 5 ~ 7：固定为1
                - 0x1F7: out
                    - 0xEC: 识别硬盘
                    - 0x20: 读硬盘
                    - 0x30: 写硬盘
                - 0x1F7: in / 8bit
                    - 0 ERR
                    - 3 DRQ 数据准备完毕
                    - 7 BSY 硬盘繁忙
            
            LBA48:
                LBA48 寻址模式：
                在 LBA48 模式下，硬盘的寻址机制使用 48 位的逻辑块地址
                LBA48 寻址硬盘控制端口（基于 LBA28 的扩展）

                | Primary 通道            | Secondary 通道 | in 操作      | out 操作     |
                | ----------------------- | -------------- | ------------ | ------------ |
                | 0x1F0                   | 0x170          | Data         | Data         |
                | 0x1F1                   | 0x171          | Error        | Features     |
                | 0x1F2                   | 0x172          | Sector count | Sector count |
                | 0x1F3                   | 0x173          | LBA low      | LBA low      |
                | 0x1F4                   | 0x174          | LBA mid      | LBA mid      |
                | 0x1F5                   | 0x175          | LBA high     | LBA high     |
                | 0x1F6                   | 0x176          | LBA high 2   | LBA high 2   |
                | 0x1F7                   | 0x177          | Status       | Command      |

                解释：

                - **0x1F0：16bit 端口，用于读写数据**：
                    - 用于数据传输，可以在硬盘和内存之间传输数据。

                - **0x1F1：检测前一个指令的错误**：
                    - 该端口返回设备的错误状态。

                - **0x1F2：读写扇区的数量**：
                    - 用于指定要读写的扇区数量。

                - **0x1F3：起始扇区的 0 ~ 7 位**：
                    - LBA 的低 8 位，指定读写操作的起始扇区的低部分。

                - **0x1F4：起始扇区的 8 ~ 15 位**：
                    - LBA 的中 8 位，指定读写操作的起始扇区的中部分。

                - **0x1F5： 中起始扇区的 16 ~ 23 位**：
                    - LBA 的高 8 位，指定读写操作的起始扇区的高部分。

                - **0x1F6**：
                    - **0 ~ 3：起始扇区的 24 ~ 27 位**：
                        - LBA48 模式需要 48 位寻址，这里存放的是 LBA 的高位部分（24 ~ 27）。
                    - **4：0 主盘, 1 从盘**：
                        - 用于指定硬盘是主盘还是从盘。
                    - **6：0 CHS, 1 LBA**：
                        - 指定当前使用的是 CHS 寻址模式还是 LBA 寻址模式。LBA48 模式下，应该选择 1（LBA）。
                    - **5 ~ 7：固定为 1**：
                        - 这三位是保留位，始终设置为 1。

                - **0x1F7：out**
                    - **0xEC：识别硬盘**：
                        - 该命令用于识别硬盘设备，返回硬盘信息。
                    - **0x20：读硬盘**：
                        - 该命令用于读取硬盘数据。
                    - **0x30：写硬盘**：
                        - 该命令用于写入硬盘数据。

                - **0x1F7：in / 8bit**
                    - **0 ERR**：
                        - 错误标志位，表示上一个操作是否出错。
                    - **3 DRQ 数据准备完毕**：
                        - 数据请求信号位，表示硬盘准备好进行数据传输。
                    - **7 BSY 硬盘繁忙**：
                        - 硬盘忙碌标志位，表示硬盘正在执行某个操作。

                LBA48 扩展部分：
                - LBA48 使用了更多的位数来扩展硬盘寻址空间，因此需要额外的寄存器来存储高位的扇区地址。
                - **LBA high 2**（寄存器 `0x1F6` 的高位部分）用于存储 LBA 地址的更高部分（24 ~ 47 位），使得硬盘控制器能够支持更大的存储空间。

    3.GRUB 开机引导加载程序
        mbr+bios
        gpt+uefi

        MBR
            +--------------------+--------------------------+--------------------+
            | 引导程序           | 分区表（4个分区项，每个16字节）| 启动签名（0x55AA）|
            | (446 字节)         | (64 字节)                | (2 字节)           |
            +--------------------+--------------------------+--------------------+

        分区表结构
            引导标志（Boot Flag）	1 字节	标识该分区是否为活动分区（启动分区）。值为 0x80 时表示活动分区，0x00 表示非活动分区。
            起始 CHS（Start CHS）	3 字节	存储分区的起始位置（柱面-磁头-扇区）。这是早期的物理寻址方式。
            分区类型（Partition Type）	1 字节	分区类型标识符，表示分区的文件系统类型（例如 0x07 表示 NTFS，0x83 表示 Linux 等）。
            结束 CHS（End CHS）	3 字节	存储分区的结束位置（柱面-磁头-扇区）。用于标识分区结束的物理位置。
            起始 LBA（Start LBA）	4 字节	分区的起始逻辑块地址，LBA 是现代硬盘的寻址方式，表示分区在磁盘上的起始位置（扇区偏移）。
            分区大小（Size）	4 字节	分区的大小（以扇区为单位），指示分区的大小。

        fdisk工具 进行分区
        
## 5. IO端口地址分配
    ### x86 I/O 端口地址分配

| **端口地址范围** | **用途**                                | **说明**                                              |
|------------------|-----------------------------------------|-------------------------------------------------------|
| 0x0000 - 0x007F  | **DMA 控制器**                          | 用于直接存储访问（DMA）控制器的地址。                          |
| 0x0100 - 0x01FF  | **通用串口控制器（COM1, COM2）**         | 用于串行端口控制，常见于 COM1（0x3F8）和 COM2（0x2F8）。       |
| 0x0200 - 0x03FF  | **并行端口（LPT1, LPT2）**              | 用于并行打印机端口控制，常见于 LPT1（0x378）和 LPT2（0x278）。  |
| 0x0400 - 0x04FF  | **硬盘控制器**                          | 用于 IDE 硬盘控制器，操作硬盘的读取和写入操作。                   |
| 0x0600 - 0x07FF  | **时钟控制器（RTC）**                   | 用于实时钟表（RTC）设置和查询，操作硬件时钟。                      |
| 0x0800 - 0x08FF  | **系统控制器（SIO）**                   | 用于系统中断控制，管理外部中断、硬件中断。                         |
| 0x0A00 - 0x0AFF  | **键盘控制器**                          | 用于处理键盘输入和控制。                                       |
| 0x0C00 - 0x0CFF  | **系统自检（POST）端口**               | 用于启动自检程序，检查系统硬件设备的健康状况。                      |
| 0x1F0 - 0x1F7    | **硬盘 IDE 控制器（Primary）**          | 主要用于硬盘的 IDE 控制器，执行磁盘操作，如读写数据。                 |
| 0x3F6 - 0x3F6    | **硬盘 IDE 控制器（Secondary）**        | 用于硬盘的第二个 IDE 控制器（用于从盘）。                            |
| 0x3B0 - 0x3DF    | **显卡寄存器**                          | 用于显示适配器或显卡的控制和操作。                                   |
| 0x4000 - 0x4FFF  | **声音卡控制器**                        | 用于音频设备和声音卡的 I/O 控制。                                    |
| 0x5000 - 0x5FFF  | **网卡控制器**                          | 用于网络接口控制器的 I/O 地址，执行网络数据传输。                      |
| 0x6000 - 0x6FFF  | **USB 控制器**                          | 用于 USB 设备的 I/O 操作，处理数据传输与设备连接。                    |
| 0x7000 - 0x7FFF  | **扩展 I/O 设备**                       | 用于各种扩展 I/O 设备，具体取决于计算机硬件配置。                      |

### 说明：
- **0x0000 - 0x007F**：这些端口通常用于直接存储访问（DMA）控制器，这些控制器在数据传输时直接与内存交互，不经过 CPU。
- **0x0100 - 0x01FF**：这是常见的串口端口，用于串行通信设备（如鼠标、调制解调器等）。
- **0x0200 - 0x03FF**：用于并行端口（LPT1, LPT2），用于连接打印机等设备。
- **0x0400 - 0x04FF**：硬盘控制器的端口地址，通常用于 IDE 硬盘操作。
- **0x0600 - 0x07FF**：时钟控制器地址范围，主要用于操作和查询硬件时钟。
- **0x0800 - 0x08FF**：这些端口用于系统的中断管理，特别是用于外设与 CPU 之间的通信。
- **0x1F0 - 0x1F7**：这是 IDE 控制器的端口，用于执行硬盘的读写操作。
- **0x3F6 - 0x3F6**：第二个 IDE 控制器的端口地址，用于从硬盘进行数据传输。
- **0x4000 - 0x4FFF**：用于音频设备的 I/O 控制，常见于声卡等设备。
- **0x5000 - 0x5FFF**：网卡的控制端口，用于网络数据的传输控制。
- **0x6000 - 0x6FFF**：USB 设备的端口范围，负责与计算机进行 USB 数据交换。
- **0x7000 - 0x7FFF**：这部分通常用于扩展 I/O 设备，如其他外部设备的控制。
   